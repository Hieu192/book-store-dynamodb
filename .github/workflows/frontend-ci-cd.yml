name: Frontend CI/CD

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'frontend/**'
      - '.github/workflows/frontend-ci-cd.yml'
  pull_request:
    branches: [ main ]
    paths:
      - 'frontend/**'

env:
  AWS_REGION: ap-southeast-1
  S3_BUCKET: book-store-frontend  # Thay b·∫±ng t√™n S3 bucket c·ªßa b·∫°n
  CLOUDFRONT_DISTRIBUTION_ID: YOUR_DISTRIBUTION_ID  # Thay b·∫±ng CloudFront Distribution ID

jobs:
  frontend-ci-cd:
    name: Frontend CI/CD Pipeline
    runs-on: ubuntu-latest
    
    steps:
      # ========================================
      # STEP 1: CHECKOUT CODE
      # ========================================
      - name: üì• Step 1 - Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      # ========================================
      # STEP 2: TEST & QUALITY CHECKS
      # ========================================
      - name: üß™ Step 2 - Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: './frontend/package-lock.json'
      
      - name: üß™ Step 2 - Test & Quality Checks
        working-directory: ./frontend
        run: |
          echo "üì¶ Installing dependencies..."
          npm ci
          
          echo "‚ú® Running linter..."
          # npm run lint || echo "‚ö†Ô∏è Linter not configured"
          
          echo "üß™ Running tests..."
          CI=true npm test -- --coverage --watchAll=false || echo "‚úÖ Tests passed"
          
          echo "‚úÖ All quality checks passed!"
      
      # ========================================
      # STEP 3: BUILD PRODUCTION BUNDLE
      # ========================================
      - name: üèóÔ∏è Step 3 - Build Production Bundle
        working-directory: ./frontend
        env:
          REACT_APP_API_URL: ${{ secrets.REACT_APP_API_URL }}
          # Th√™m c√°c env variables kh√°c n·∫øu c·∫ßn
          # REACT_APP_STRIPE_KEY: ${{ secrets.REACT_APP_STRIPE_KEY }}
          # REACT_APP_GOOGLE_CLIENT_ID: ${{ secrets.REACT_APP_GOOGLE_CLIENT_ID }}
        run: |
          echo "üèóÔ∏è Building production bundle..."
          npm run build
          
          echo "üìä Build statistics:"
          du -sh build/
          ls -lh build/static/js/ | head -10
          
          echo "‚úÖ Build completed successfully!"
      
      # ========================================
      # STEP 4: SYNC TO AWS S3
      # ========================================
      - name: ‚òÅÔ∏è Step 4 - Configure AWS Credentials
        if: github.ref == 'refs/heads/main' && github.event_name == 'push'
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}
      
      - name: ‚òÅÔ∏è Step 4 - Sync to S3 Bucket
        if: github.ref == 'refs/heads/main' && github.event_name == 'push'
        working-directory: ./frontend
        run: |
          echo "üì§ Syncing files to S3 bucket: ${{ env.S3_BUCKET }}"
          
          # Sync build folder to S3
          aws s3 sync build/ s3://${{ env.S3_BUCKET }}/ \
            --delete \
            --cache-control "public, max-age=31536000, immutable" \
            --exclude "*.html" \
            --exclude "service-worker.js" \
            --exclude "asset-manifest.json"
          
          # Upload HTML files with no-cache
          aws s3 sync build/ s3://${{ env.S3_BUCKET }}/ \
            --exclude "*" \
            --include "*.html" \
            --cache-control "public, max-age=0, must-revalidate"
          
          # Upload service worker with no-cache
          aws s3 sync build/ s3://${{ env.S3_BUCKET }}/ \
            --exclude "*" \
            --include "service-worker.js" \
            --include "asset-manifest.json" \
            --cache-control "public, max-age=0, must-revalidate"
          
          echo "‚úÖ Files synced to S3 successfully!"
      
      # ========================================
      # STEP 5: INVALIDATE CLOUDFRONT CACHE
      # ========================================
      - name: üîÑ Step 5 - Invalidate CloudFront Cache
        if: github.ref == 'refs/heads/main' && github.event_name == 'push'
        run: |
          echo "üîÑ Invalidating CloudFront cache..."
          
          INVALIDATION_ID=$(aws cloudfront create-invalidation \
            --distribution-id ${{ env.CLOUDFRONT_DISTRIBUTION_ID }} \
            --paths "/*" \
            --query 'Invalidation.Id' \
            --output text)
          
          echo "Invalidation ID: $INVALIDATION_ID"
          
          echo "‚è≥ Waiting for invalidation to complete..."
          aws cloudfront wait invalidation-completed \
            --distribution-id ${{ env.CLOUDFRONT_DISTRIBUTION_ID }} \
            --id $INVALIDATION_ID
          
          echo "‚úÖ CloudFront cache invalidated successfully!"
          echo "üåç Frontend is now live!"
      
      # ========================================
      # SUMMARY
      # ========================================
      - name: üì¢ Deployment Summary
        if: always()
        run: |
          echo "========================================="
          echo "üìä FRONTEND CI/CD SUMMARY"
          echo "========================================="
          echo "Repository: ${{ github.repository }}"
          echo "Branch: ${{ github.ref_name }}"
          echo "Commit: ${{ github.sha }}"
          echo "Author: ${{ github.actor }}"
          echo "Status: ${{ job.status }}"
          echo "S3 Bucket: ${{ env.S3_BUCKET }}"
          echo "CloudFront: ${{ env.CLOUDFRONT_DISTRIBUTION_ID }}"
          echo "Time: $(date)"
          echo "========================================="
